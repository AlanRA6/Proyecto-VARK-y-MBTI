{% extends "partials/base_t.html" %}

{% block extra_css %}
<style>
.card {
    border-radius: 10px;
    border: none;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.card-header {
    border-bottom: 2px solid #f0f0f0;
    border-radius: 10px 10px 0 0 !important;
    padding: 1rem 1.25rem;
}

canvas {
    max-height: 350px;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.bg-primary {
    background-color: #0d6efd !important;
}

.bg-success {
    background-color: #198754 !important;
}

.bg-info {
    background-color: #0dcaf0 !important;
}

.bg-warning {
    background-color: #ffc107 !important;
}

.bg-purple {
    background-color: #6f42c1 !important;
    color: white;
}

.form-select, .btn {
    border-radius: 8px;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    transition: all 0.3s;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
    canvas {
        max-height: 250px;
    }
    
    .card-body h3 {
        font-size: 1.5rem;
    }
}

.opacity-50 {
    opacity: 0.5;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.mbti-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 5px;
    font-weight: bold;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado del Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-brain me-2"></i>Dashboard MBTI - Tipos de Personalidad
            </h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Tipo de vista -->
                        <div class="col-md-4">
                            <label for="filtroTipo" class="form-label fw-bold">
                                <i class="fas fa-filter me-2"></i>Tipo de Vista
                            </label>
                            <select id="filtroTipo" class="form-select">
                                <option value="total" {% if filtro == 'total' %}selected{% endif %}>Vista Total</option>
                                <option value="individual" {% if filtro == 'individual' %}selected{% endif %}>Individual</option>
                                <option value="grupal" {% if filtro == 'grupal' %}selected{% endif %}>Grupal</option>
                            </select>
                        </div>

                        <!-- Token específico (Individual) -->
                        <div class="col-md-4" id="filtroIndividualContainer" style="display: none;">
                            <label for="filtroIndividual" class="form-label fw-bold">
                                <i class="fas fa-user me-2"></i>Token Individual
                            </label>
                            <select id="filtroIndividual" class="form-select">
                                <option value="">Todos los tokens individuales</option>
                                {% for token in tokens_individuales %}
                                <option value="{{ token.id }}">{{ token.token }} - {{ token.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Token específico (Grupal) -->
                        <div class="col-md-4" id="filtroGrupalContainer" style="display: none;">
                            <label for="filtroGrupal" class="form-label fw-bold">
                                <i class="fas fa-users me-2"></i>Token Grupal
                            </label>
                            <select id="filtroGrupal" class="form-select">
                                <option value="">Todos los tokens grupales</option>
                                {% for token in tokens_grupales %}
                                <option value="{{ token.id }}">{{ token.token }} - {{ token.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Botón aplicar -->
                        <div class="col-md-4 d-flex align-items-end">
                            <button id="btnAplicarFiltros" class="btn btn-primary w-100">
                                <i class="fas fa-sync-alt me-2"></i>Actualizar Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Total Tests</h6>
                            <h3 class="mb-0" id="totalFormularios">0</h3>
                        </div>
                        <i class="fas fa-clipboard-list fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Tipo Más Común</h6>
                            <h3 class="mb-0" id="tipoMasComun">-</h3>
                        </div>
                        <i class="fas fa-trophy fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Introvertidos</h6>
                            <h3 class="mb-0" id="porcentajeIntrovertidos">0%</h3>
                        </div>
                        <i class="fas fa-user-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-dark shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Extrovertidos</h6>
                            <h3 class="mb-0" id="porcentajeExtrovertidos">0%</h3>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Primera fila de gráficas -->
    <div class="row mb-4">
        <!-- Gráfica de barras: Top 10 tipos MBTI -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Distribución por Tipo MBTI
                    </h5>
                    <small class="text-muted">Top tipos de personalidad</small>
                </div>
                <div class="card-body">
                    <canvas id="chartTiposMBTI"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfica de dona: Temperamentos -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2 text-success"></i>
                        Temperamentos Keirsey
                    </h5>
                    <small class="text-muted">Agrupación por temperamento</small>
                </div>
                <div class="card-body">
                    <canvas id="chartTemperamentos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda fila de gráficas -->
    <div class="row mb-4">
        <!-- Gráfica de radar: 4 Dimensiones -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram me-2 text-info"></i>
                        Distribución por Dimensiones
                    </h5>
                    <small class="text-muted">Energía, Información, Decisiones, Estilo de Vida</small>
                </div>
                <div class="card-body">
                    <canvas id="chartDimensiones"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfica de barras horizontales: Roles -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tag me-2 text-warning"></i>
                        Distribución por Roles
                    </h5>
                    <small class="text-muted">Analistas, Diplomáticos, Centinelas, Exploradores</small>
                </div>
                <div class="card-body">
                    <canvas id="chartRoles"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera fila: Dimensiones individuales -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Energía (E/I)</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartEnergia"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Información (S/N)</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartInformacion"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Decisiones (T/F)</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartDecisiones"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Estilo de Vida (J/P)</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartEstilo"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Estudiantes (solo vista individual) -->
    <div class="row mb-4" id="topEstudiantesContainer" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-medal me-2 text-warning"></i>
                        Estudiantes Evaluados
                    </h5>
                    <small class="text-muted">Top 5 estudiantes con más tests completados</small>
                </div>
                <div class="card-body">
                    <canvas id="chartTopEstudiantes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del dashboard...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Scripts personalizados -->
<script>
let charts = {};

// Colores para MBTI
const coloresMBTI = {
    temperamentos: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'],
    roles: ['#667eea', '#764ba2', '#f093fb', '#4facfe'],
    dimensiones: ['#5f27cd', '#00d2d3', '#ff9ff3', '#feca57']
};

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    configurarFiltros();
    cargarDatos();
});

// Configurar comportamiento de filtros
function configurarFiltros() {
    const filtroTipo = document.getElementById('filtroTipo');
    const btnAplicar = document.getElementById('btnAplicarFiltros');
    
    filtroTipo.addEventListener('change', function() {
        mostrarFiltrosEspecificos(this.value);
    });
    
    btnAplicar.addEventListener('click', cargarDatos);
    
    // Mostrar filtros iniciales
    mostrarFiltrosEspecificos(filtroTipo.value);
}

function mostrarFiltrosEspecificos(tipo) {
    const individualContainer = document.getElementById('filtroIndividualContainer');
    const grupalContainer = document.getElementById('filtroGrupalContainer');
    
    individualContainer.style.display = tipo === 'individual' ? 'block' : 'none';
    grupalContainer.style.display = tipo === 'grupal' ? 'block' : 'none';
}

// Cargar datos del servidor
async function cargarDatos() {
    const filtroTipo = document.getElementById('filtroTipo').value;
    let tokenId = '';
    
    if (filtroTipo === 'individual') {
        tokenId = document.getElementById('filtroIndividual').value;
    } else if (filtroTipo === 'grupal') {
        tokenId = document.getElementById('filtroGrupal').value;
    }
    
    mostrarSpinner(true);
    
    try {
        const url = `{% url 'dashboard_mbti_data' %}?filtro=${filtroTipo}&token_id=${tokenId}`;
        const response = await fetch(url);
        const data = await response.json();
        
        actualizarDashboard(data, filtroTipo);
    } catch (error) {
        console.error('Error al cargar datos:', error);
        alert('Error al cargar los datos del dashboard');
    } finally {
        mostrarSpinner(false);
    }
}

function mostrarSpinner(mostrar) {
    document.getElementById('loadingSpinner').style.display = mostrar ? 'block' : 'none';
}

// Actualizar todo el dashboard
function actualizarDashboard(data, filtroTipo) {
    actualizarTarjetasResumen(data);
    actualizarGraficaTiposMBTI(data.distribucion_tipos);
    actualizarGraficaTemperamentos(data.temperamentos);
    actualizarGraficaDimensiones(data);
    actualizarGraficaRoles(data.roles);
    actualizarGraficasIndividuales(data);
    
    // Mostrar top estudiantes solo en vista individual
    if (filtroTipo === 'individual' && data.top_estudiantes.length > 0) {
        document.getElementById('topEstudiantesContainer').style.display = 'block';
        actualizarGraficaTopEstudiantes(data.top_estudiantes);
    } else {
        document.getElementById('topEstudiantesContainer').style.display = 'none';
    }
}

// Actualizar tarjetas de resumen
function actualizarTarjetasResumen(data) {
    const total = data.total_formularios;
    document.getElementById('totalFormularios').textContent = total;
    
    // Tipo más común
    const tipos = Object.entries(data.distribucion_tipos);
    if (tipos.length > 0) {
        const masComun = tipos.reduce((a, b) => a[1] > b[1] ? a : b);
        document.getElementById('tipoMasComun').textContent = masComun[0];
    }
    
    // Porcentajes E/I
    const totalE = data.distribucion_energia.E || 0;
    const totalI = data.distribucion_energia.I || 0;
    const totalEnergia = totalE + totalI;
    
    if (totalEnergia > 0) {
        document.getElementById('porcentajeExtrovertidos').textContent = 
            Math.round((totalE / totalEnergia) * 100) + '%';
        document.getElementById('porcentajeIntrovertidos').textContent = 
            Math.round((totalI / totalEnergia) * 100) + '%';
    }
}

// Gráfica de tipos MBTI
function actualizarGraficaTiposMBTI(distribucion) {
    if (charts.tiposMBTI) charts.tiposMBTI.destroy();
    
    const tipos = Object.entries(distribucion).sort((a, b) => b[1] - a[1]).slice(0, 10);
    
    const ctx = document.getElementById('chartTiposMBTI').getContext('2d');
    charts.tiposMBTI = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: tipos.map(t => t[0]),
            datasets: [{
                label: 'Cantidad',
                data: tipos.map(t => t[1]),
                backgroundColor: '#667eea',
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Gráfica de temperamentos
function actualizarGraficaTemperamentos(temperamentos) {
    if (charts.temperamentos) charts.temperamentos.destroy();
    
    const ctx = document.getElementById('chartTemperamentos').getContext('2d');
    charts.temperamentos = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(temperamentos),
            datasets: [{
                data: Object.values(temperamentos),
                backgroundColor: coloresMBTI.temperamentos,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Gráfica de dimensiones (radar)
function actualizarGraficaDimensiones(data) {
    if (charts.dimensiones) charts.dimensiones.destroy();
    
    const ctx = document.getElementById('chartDimensiones').getContext('2d');
    charts.dimensiones = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Extrovertidos', 'Introvertidos', 'Sensitivos', 'Intuitivos', 
                     'Pensadores', 'Sentimentales', 'Juiciosos', 'Perceptivos'],
            datasets: [{
                label: 'Distribución',
                data: [
                    data.distribucion_energia.E,
                    data.distribucion_energia.I,
                    data.distribucion_informacion.S,
                    data.distribucion_informacion.N,
                    data.distribucion_decisiones.T,
                    data.distribucion_decisiones.F,
                    data.distribucion_estilo.J,
                    data.distribucion_estilo.P
                ],
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(102, 126, 234, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Gráfica de roles
function actualizarGraficaRoles(roles) {
    if (charts.roles) charts.roles.destroy();
    
    const ctx = document.getElementById('chartRoles').getContext('2d');
    charts.roles = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(roles),
            datasets: [{
                label: 'Cantidad',
                data: Object.values(roles),
                backgroundColor: coloresMBTI.roles,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Gráficas individuales de dimensiones
function actualizarGraficasIndividuales(data) {
    // Energía
    crearGraficaDimension('chartEnergia', data.distribucion_energia, ['#FF6B6B', '#4ECDC4']);
    
    // Información
    crearGraficaDimension('chartInformacion', data.distribucion_informacion, ['#45B7D1', '#FFA07A']);
    
    // Decisiones
    crearGraficaDimension('chartDecisiones', data.distribucion_decisiones, ['#5f27cd', '#00d2d3']);
    
    // Estilo
    crearGraficaDimension('chartEstilo', data.distribucion_estilo, ['#ff9ff3', '#feca57']);
}

function crearGraficaDimension(chartId, data, colores) {
    if (charts[chartId]) charts[chartId].destroy();
    
    const ctx = document.getElementById(chartId).getContext('2d');
    charts[chartId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: colores,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Gráfica top estudiantes
function actualizarGraficaTopEstudiantes(estudiantes) {
    if (charts.topEstudiantes) charts.topEstudiantes.destroy();
    
    const ctx = document.getElementById('chartTopEstudiantes').getContext('2d');
    charts.topEstudiantes = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: estudiantes.map(e => e.alumno__nombre),
            datasets: [{
                label: 'Tests Completados',
                data: estudiantes.map(e => e.total_tests),
                backgroundColor: '#667eea',
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
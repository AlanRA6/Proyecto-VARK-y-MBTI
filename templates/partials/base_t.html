{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard Docente | Quizzes Solutions{% endblock %}</title>
        <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome para iconos modernos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.26.3/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- CSS del Dashboard -->
    <link rel="stylesheet" href="{% static 'css/base_t.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- NAVBAR FIXED -->
    <header class="dash-header">
        <div class="header-content">
            
            <!-- 1. MARCA / LOGO + TOGGLE MÓVIL -->
            <div class="brand-wrapper">
                <div class="dash-brand">
                    <span class="brand-icon"><i class="fa-solid fa-shapes"></i></span>
                    <div class="brand-text">
                        <h1>Quizzes Solutions</h1>
                        <span class="badge">Docente</span>
                    </div>
                </div>

                <!-- Botón Hamburguesa (Solo visible en Móvil) -->
                <button class="dash-toggle" id="dashToggle" aria-label="Abrir menú">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>

            <!-- 2. CONTENIDO COLAPSABLE (NAV + USER) -->
            <div class="dash-collapse" id="dashCollapse">
                
                <!-- Navegación Central -->
                <nav class="dash-nav">
                    <ul>
                        <li>
                            <a href="{% url 'teachers_home' %}" class="dash-link {% if request.resolver_match.url_name == 'teachers_home' %}active{% endif %}">
                                <i class="fa-solid fa-house"></i> <span>Inicio</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'reports_list' %}" class="dash-link {% if request.resolver_match.url_name == 'reports_list' %}active{% endif %}">
                                <i class="fa-solid fa-file"></i> <span>Reportes</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'tokens_view' %}" class="dash-link {% if request.resolver_match.url_name == 'tokens_view' %}active{% endif %}">
                                <i class="fa-solid fa-key"></i> <span>Tokens</span>
                            </a>
                        </li>
                        <li>
                            <a id="search_link" href="#" class="dash-link {% if request.resolver_match.url_name == 'search' %}active{% endif %}">
                                <i class="fa-solid fa-magnifying-glass"></i> <span>Buscar</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Área de Usuario & Logout -->
                <div class="user-area">
                    <div class="user-info">
                        <span class="user-name">Hola, {{ user.first_name|default:user.username }}</span>
                        <span class="user-role">Maestro</span>
                    </div>
                    
                    <!-- Botón de Logout -->
                    <form action="{% url 'logout' %}" method="post" class="logout-form">
                        {% csrf_token %}
                        <button type="submit" class="btn-logout" title="Cerrar Sesión">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span class="logout-text-mobile">Cerrar Sesión</span>
                        </button>
                    </form>
                </div>

            </div> <!-- Fin .dash-collapse -->

        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main class="dash-main">
        {% block content %}
        <!-- El contenido del dashboard va aquí -->
        {% endblock %}
    </main>


    <!-- JS Scripts -->
    <script src="{% static 'js/base_t.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.26.3/dist/sweetalert2.all.min.js"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
<script>
    const searchLink = document.getElementById('search_link');

    searchLink.addEventListener('click', function(event){
        event.preventDefault();
        searchReport();
    });

    async function searchReport() {
        const result = await Swal.fire({
            title: 'Buscar Reporte',
            html: `
                <span>¡La función de buscar está limitada a búsquedas individuales!</span>
                <select id="tipoReporte" class="swal2-select" style="width: 70%; margin-bottom: 10px;">
                    <option value="">Seleccione un tipo de reporte</option>
                    <option value="vark">VARK</option>
                    <option value="mbti">MBTI</option>
                </select>

                <input id="tokenInput" class="swal2-input" placeholder="Token del reporte">
            `,
            showCancelButton: true,
            confirmButtonText: 'Buscar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const tipo = document.getElementById('tipoReporte').value;
                const token = document.getElementById('tokenInput').value;

                if (!tipo) {
                    Swal.showValidationMessage('Debe seleccionar el tipo de reporte');
                    return false;
                }
                if (!token) {
                    Swal.showValidationMessage('Debe ingresar un token');
                    return false;
                }

                return { tipo, token };
            }
        });

        // Si canceló, no seguimos
        if (!result.isConfirmed) return;

        const tipoReporte = result.value.tipo;
        const tokenValue  = result.value.token;

        // Ahora sí puedes usar await sin errores
        const data = await searchData(tokenValue, tipoReporte);
        if(data.error){
            Swal.fire({
                title: 'Error',
                text: data.error,
                icon: 'error'
            });
            return;
        }
        await mostrarSwals(data);
    }


    async function searchData(token, type){
        const baseUrl = "{% url 'search_token' 'TOKEN_PLACEHOLDER' 'TYPE_PLACEHOLDER' %}";
        const finalUrl = baseUrl.replace("TOKEN_PLACEHOLDER", token).replace("TYPE_PLACEHOLDER", type);
        const response = await fetch(finalUrl);
        if (response.ok) {
            const data = await response.json();
            return data;
        } else {
            const errorData = await response.json();
            return errorData;
        }
    }

    async function mostrarSwals(data) {
        for (const item of data.reportes) {
            const result = await Swal.fire({
                title: 'Resultado',
                html: `
                    <p><strong>Alumno:</strong> ${item.alumno}</p>
                    <p><strong>Fecha:</strong> ${item.fecha_completado}</p>
                    <p><strong>ID:</strong> ${item.id}</p>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Ver Reporte',
                cancelButtonText: 'Cerrar'
            });
            if (result.isConfirmed) {
                let reportUrl = '';
                if (item.tipo === 'vark') {
                    reportUrl = "{% url 'vark_individual_report' 0 %}".replace('0', item.id);
                } else if (item.tipo === 'mbti') {
                    reportUrl = "{% url 'mbti_individual_report' 0 %}".replace('0', item.id);
                }
                window.open(reportUrl, "_blank");
            }
        }
    }
</script>